name: Deploy to Google Apps Script

permissions:
  contents: read
  deployments: write

on:
  push:
    branches:
      - main
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  deploy_preview:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - name: Create Deployment
        uses: chrnorm/deployment-action@v2
        id: deployment
        with:
          token: "${{ secrets.GITHUB_TOKEN }}"
          environment: "preview-pr-${{ github.event.number }}"
          status: "in_progress"
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install clasp
        run: npm install -g @google/clasp

      - name: Create .clasp.json for Preview
        run: |
          cp .clasp.json.template .clasp.json
          sed -i "s/__SCRIPT_ID__/${{ secrets.PREVIEW_SCRIPT_ID }}/g" .clasp.json

      - name: Create .clasprc.json
        run: echo '${{ secrets.CLASP_RC }}' > ~/.clasprc.json

      - name: Push code to GAS
        run: npx clasp push --force

      - name: Create new deployment
        id: deploy
        run: |
          npx clasp deploy --description "Preview for PR #${{ github.event.number }} - ${{ github.sha }}" > deployment-output.txt
          cat deployment-output.txt
          DEPLOYMENT_ID=$(awk '{print $2}' deployment-output.txt)
          URL="https://script.google.com/macros/s/${DEPLOYMENT_ID}/exec"
          echo "url=$URL" >> $GITHUB_OUTPUT

      - name: Update deployment status (Success)
        if: success()
        uses: chrnorm/deployment-action@v2
        with:
          token: "${{ secrets.GITHUB_TOKEN }}"
          deployment_id: ${{ steps.deployment.outputs.deployment_id }}
          environment_url: ${{ steps.deploy.outputs.url }}
          status: "success"

      - name: Update deployment status (Failure)
        if: failure() || cancelled()
        uses: chrnorm/deployment-action@v2
        with:
          token: "${{ secrets.GITHUB_TOKEN }}"
          deployment_id: ${{ steps.deployment.outputs.deployment_id }}
          status: "failure"

  deploy_production:
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install clasp
        run: npm install -g @google/clasp

      - name: Create .clasp.json for Production
        run: |
          cp .clasp.json.template .clasp.json
          sed -i "s/__SCRIPT_ID__/${{ secrets.PRODUCTION_SCRIPT_ID }}/g" .clasp.json

      - name: Create .clasprc.json
        run: echo '${{ secrets.CLASP_RC }}' > ~/.clasprc.json

      - name: Push code to GAS
        run: npx clasp push --force

      - name: Update production deployment
        run: npx clasp deploy --deploymentId ${{ secrets.PRODUCTION_DEPLOYMENT_ID }} --description "Production Release ${{ github.sha }}"
