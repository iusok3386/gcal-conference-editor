<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; max-width: 600px; }
    form, #selection-container { display: flex; flex-direction: column; gap: 15px; }
    label { font-weight: bold; }
    input[type="text"], input[type="url"], select, textarea {
      padding: 8px; border: 1px solid #ccc; border-radius: 4px; width: 100%;
      box-sizing: border-box; font-size: 14px;
    }
    textarea { resize: vertical; }
    button {
      padding: 10px 15px; background-color: #4285F4; color: white; border: none;
      border-radius: 4px; cursor: pointer; font-size: 14px; align-self: flex-start;
    }
    button:disabled { background-color: #aaa; cursor: not-allowed; }
    #status { margin-top: 15px; padding: 10px; border-radius: 4px; display: none; }
    .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    .loader {
      border: 4px solid #f3f3f3; border-radius: 50%; border-top: 4px solid #3498db;
      width: 16px; height: 16px; animation: spin 2s linear infinite;
      display: none; margin-left: 10px; vertical-align: middle;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .entry-point { border: 1px solid #eee; padding: 15px; border-radius: 8px; margin-top: 10px; }
    .entry-point div { display: flex; flex-direction: column; gap: 5px; margin-bottom: 10px; }
    .entry-point .remove-entry-point { background-color: #db4437; align-self: flex-end; }
    #icon-preview { max-width: 24px; max-height: 24px; vertical-align: middle; margin-left: 10px; display: none; }
    hr { border: 0; border-top: 1px solid #ccc; margin: 20px 0; }
    .button-group { display: flex; gap: 10px; }
  </style>
</head>
<body>
  <h1>Google カレンダー 会議情報編集ツール</h1>
  <p>カレンダーとイベントを選択して、会議情報を編集します。</p>

  <div id="selection-container">
    <div>
      <label for="calendar-select">1. カレンダーを選択:</label>
      <select id="calendar-select" name="calendarId" required disabled>
        <option value="">カレンダーを読み込み中...</option>
      </select>
    </div>
    <div>
      <label for="event-select">2. イベントを選択:</label>
      <select id="event-select" name="eventId" required disabled>
        <option value="">カレンダーを選択してください</option>
      </select>
      <div id="event-loader" class="loader"></div>
    </div>
  </div>

  <form id="conference-form" style="display:none;">
    <hr>
    <h3>会議ソリューション</h3>
    <div>
      <label for="name">名前:</label>
      <input type="text" id="name" name="name">
    </div>
    <div>
      <label for="iconUri">アイコン URI:</label>
      <input type="url" id="iconUri" name="iconUri">
      <img id="icon-preview" src="" alt="Icon Preview">
      <a id="icon-link" href="#" target="_blank" style="display: none; margin-left: 10px;">リンクを確認</a>
    </div>
    <div>
      <label for="type">キータイプ:</label>
      <select id="type" name="type">
        <option value="addOn">addOn</option>
        <option value="hangoutsMeet">hangoutsMeet</option>
        <option value="eventHangout">eventHangout</option>
        <option value="eventNamedHangout">eventNamedHangout</option>
      </select>
    </div>
    <div>
      <label for="conferenceId">会議 ID:</label>
      <input type="text" id="conferenceId" name="conferenceId">
    </div>
    <div>
      <label for="notes">メモ:</label>
      <textarea id="notes" name="notes" rows="4"></textarea>
    </div>

    <h3>エントリーポイント</h3>
    <div id="entry-points-container"></div>
    <button type="button" id="add-entry-point">エントリーポイントを追加</button>

    <div class="button-group">
      <button type="submit">会議情報を更新</button>
      <button type="button" id="delete-button" style="background-color: #db4437;">会議情報を削除</button>
    </div>
  </form>

  <div id="status"></div>

  <template id="entry-point-template">
    <div class="entry-point">
      <div>
        <label>タイプ:</label>
        <select class="entryPointType">
          <option value="video">video</option>
          <option value="phone">phone</option>
          <option value="sip">sip</option>
          <option value="more">more</option>
        </select>
      </div>
      <div>
        <label>ラベル:</label>
        <input type="text" class="label">
      </div>
      <div>
        <label>URI:</label>
        <input type="url" class="uri">
      </div>
      <button type="button" class="remove-entry-point">このエントリーポイントを削除</button>
    </div>
  </template>

  <script>
    // --- Element References ---
    const calendarSelect = document.getElementById('calendar-select');
    const eventSelect = document.getElementById('event-select');
    const eventLoader = document.getElementById('event-loader');
    const conferenceForm = document.getElementById('conference-form');
    const statusDiv = document.getElementById('status');
    const entryPointsContainer = document.getElementById('entry-points-container');
    const entryPointTemplate = document.getElementById('entry-point-template');

    // --- Utility Functions ---
    function populateSelect(select, items, defaultOptionText) {
      select.innerHTML = '';
      const defaultOption = new Option(defaultOptionText, '', true, true);
      defaultOption.disabled = true;
      select.add(defaultOption);
      items.forEach(item => select.add(new Option(item.summary, item.id)));
      select.disabled = false;
    }

    function setStatus(message, isError = false, isLoading = false) {
      statusDiv.style.display = 'block';
      statusDiv.textContent = message;
      statusDiv.className = isError ? 'error' : (isLoading ? '' : 'success');
    }

    function isValidUrl(string) {
      try {
        new URL(string);
        return true;
      } catch (_) {
        return false;
      }
    }

    function runGoogleScript(funcName, ...args) {
      return new Promise((resolve, reject) => {
        google.script.run
          .withSuccessHandler(resolve)
          .withFailureHandler(reject)
          [funcName](...args);
      });
    }

    // --- Form Population ---
    function addEntryPoint(data = {}) {
      const clone = entryPointTemplate.content.cloneNode(true);
      const entryPointDiv = clone.querySelector('.entry-point');

      const typeSelect = entryPointDiv.querySelector('.entryPointType');
      const labelInput = entryPointDiv.querySelector('.label');
      const uriInput = entryPointDiv.querySelector('.uri');

      typeSelect.value = data.entryPointType || 'video';
      labelInput.value = data.label || '';
      uriInput.value = data.uri || '';

      entryPointDiv.querySelector('.remove-entry-point').addEventListener('click', () => {
        entryPointsContainer.removeChild(entryPointDiv);
      });
      entryPointsContainer.appendChild(clone);
    }

    function populateForm(data = {}) {
      const d = data || {};
      const sol = d.conferenceSolution || {};
      const key = sol.key || {};

      document.getElementById('name').value = sol.name || '';
      document.getElementById('iconUri').value = sol.iconUri || '';
      document.getElementById('type').value = key.type || 'addOn';
      document.getElementById('conferenceId').value = d.conferenceId || '';
      document.getElementById('notes').value = d.notes || '';

      updateIconPreview();

      entryPointsContainer.innerHTML = '';
      if (d.entryPoints && d.entryPoints.length > 0) {
        d.entryPoints.forEach(ep => addEntryPoint(ep));
      } else {
        addEntryPoint(); // Add one blank entry point if none exist
      }
      conferenceForm.style.display = 'flex';
    }

    function updateIconPreview() {
        const iconUriInput = document.getElementById('iconUri');
        const iconPreview = document.getElementById('icon-preview');
        const iconLink = document.getElementById('icon-link');
        if (isValidUrl(iconUriInput.value)) {
            iconPreview.src = iconUriInput.value;
            iconPreview.style.display = 'inline-block';
            iconLink.href = iconUriInput.value;
            iconLink.style.display = 'inline-block';
        } else {
            iconPreview.style.display = 'none';
            iconLink.style.display = 'none';
        }
    }

    // --- Event Listeners ---
    window.addEventListener('load', async () => {
      try {
        const calendars = await runGoogleScript('getCalendars');
        if (calendars && calendars.length > 0) {
          populateSelect(calendarSelect, calendars, 'カレンダーを選択');
        } else {
          calendarSelect.innerHTML = '<option value="">利用可能なカレンダーがありません</option>';
        }
      } catch (err) {
        calendarSelect.innerHTML = `<option value="">カレンダーの読み込みに失敗</option>`;
        setStatus(err.message, true);
      }
    });

    calendarSelect.addEventListener('change', async () => {
      const calendarId = calendarSelect.value;
      if (!calendarId) return;

      eventSelect.disabled = true;
      conferenceForm.style.display = 'none';
      eventSelect.innerHTML = '<option value="">イベントを読み込み中...</option>';
      eventLoader.style.display = 'inline-block';

      try {
        const events = await runGoogleScript('getEvents', calendarId);
        if (events && events.length > 0) {
          populateSelect(eventSelect, events, 'イベントを選択');
        } else {
          eventSelect.innerHTML = '<option value="">イベントが見つかりません</option>';
        }
      } catch (err) {
        eventSelect.innerHTML = `<option value="">イベントの読み込みに失敗</option>`;
        setStatus(err.message, true);
      } finally {
        eventLoader.style.display = 'none';
      }
    });

    eventSelect.addEventListener('change', async () => {
      const eventId = eventSelect.value;
      const calendarId = calendarSelect.value;
      if (!eventId || !calendarId) {
        conferenceForm.style.display = 'none';
        return;
      }

      setStatus('会議情報を読み込み中...', false, true);
      try {
        const confData = await runGoogleScript('getConferenceData', calendarId, eventId);
        populateForm(confData);
        statusDiv.style.display = 'none';
      } catch (err) {
        setStatus('会議情報の読み込みに失敗しました: ' + err.message, true);
        conferenceForm.style.display = 'none';
      }
    });

    document.getElementById('iconUri').addEventListener('input', updateIconPreview);
    document.getElementById('add-entry-point').addEventListener('click', () => addEntryPoint());

    conferenceForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      const calendarId = calendarSelect.value;
      const eventId = eventSelect.value;

      // --- Build ConferenceData Object ---
      const conferenceData = {
        conferenceId: document.getElementById('conferenceId').value,
        conferenceSolution: {
          key: { type: document.getElementById('type').value },
          name: document.getElementById('name').value,
          iconUri: document.getElementById('iconUri').value,
        },
        notes: document.getElementById('notes').value,
        entryPoints: []
      };

      // --- Validate and Build Entry Points ---
      const entryPointElements = entryPointsContainer.querySelectorAll('.entry-point');
      let allUrlsValid = true;
      if (conferenceData.conferenceSolution.iconUri && !isValidUrl(conferenceData.conferenceSolution.iconUri)) {
          allUrlsValid = false;
      }

      entryPointElements.forEach(ep => {
        const uri = ep.querySelector('.uri').value;
        if (uri && !isValidUrl(uri)) {
            allUrlsValid = false;
        }
        conferenceData.entryPoints.push({
          entryPointType: ep.querySelector('.entryPointType').value,
          label: ep.querySelector('.label').value,
          uri: uri,
        });
      });

      if (!allUrlsValid) {
          setStatus('無効なURLが含まれています。修正してください。', true);
          return;
      }

      setStatus('会議情報を更新中...', false, true);
      try {
        const response = await runGoogleScript('updateConferenceData', calendarId, eventId, conferenceData);
        setStatus(response.message, !response.success);
      } catch (err) {
        setStatus('更新に失敗しました: ' + err.message, true);
      }
    });

    document.getElementById('delete-button').addEventListener('click', async () => {
        if (!confirm('本当にこのイベントの会議情報をすべて削除しますか？')) return;

        const calendarId = calendarSelect.value;
        const eventId = eventSelect.value;
        setStatus('会議情報を削除中...', false, true);
        try {
            const response = await runGoogleScript('updateConferenceData', calendarId, eventId, null);
            setStatus(response.message, !response.success);
            if(response.success) {
                populateForm(null); // Clear the form
            }
        } catch (err) {
            setStatus('削除に失敗しました: ' + err.message, true);
        }
    });

  </script>
</body>
</html>
