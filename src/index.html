<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; max-width: 600px; }
    #selection-container, #conference-form-container, #json-editor-container { display: flex; flex-direction: column; gap: 15px; }
    label { font-weight: bold; }
    input[type="text"], input[type="url"], select, textarea {
      padding: 8px; border: 1px solid #ccc; border-radius: 4px; width: 100%;
      box-sizing: border-box; font-size: 14px;
    }
    textarea { resize: vertical; min-height: 150px; font-family: monospace; }
    button {
      padding: 10px 15px; background-color: #4285F4; color: white; border: none;
      border-radius: 4px; cursor: pointer; font-size: 14px; align-self: flex-start;
    }
    button.secondary { background-color: #f1f1f1; color: #333; }
    button:disabled { background-color: #aaa; cursor: not-allowed; }
    #status { margin-top: 15px; padding: 10px; border-radius: 4px; display: none; }
    .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
    .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    .warning-text { font-size: 12px; color: #856404; background-color: #fff3cd; border: 1px solid #ffeeba; padding: 8px; border-radius: 4px; margin-top: 5px; }
    .loader {
      border: 4px solid #f3f3f3; border-radius: 50%; border-top: 4px solid #3498db;
      width: 16px; height: 16px; animation: spin 2s linear infinite;
      display: none; margin-left: 10px; vertical-align: middle;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .entry-point { border: 1px solid #eee; padding: 15px; border-radius: 8px; margin-top: 10px; }
    .entry-point div { display: flex; flex-direction: column; gap: 5px; margin-bottom: 10px; }
    .entry-point .remove-entry-point { background-color: #db4437; align-self: flex-end; }
    #icon-preview { max-width: 24px; max-height: 24px; vertical-align: middle; margin-left: 10px; display: none; }
    hr { border: 0; border-top: 1px solid #ccc; margin: 20px 0; }
    .button-group { display: flex; gap: 10px; }
    .hidden { display: none !important; }
  </style>
</head>
<body>
  <h1>Google カレンダー 会議情報編集ツール</h1>
  <p>カレンダーとイベントを選択して、会議情報を編集します。</p>

  <div id="selection-container">
    <div>
      <label for="calendar-select">1. カレンダーを選択:</label>
      <select id="calendar-select" name="calendarId" required disabled>
        <option value="">カレンダーを読み込み中...</option>
      </select>
    </div>
    <div>
      <label for="event-select">2. イベントを選択:</label>
      <select id="event-select" name="eventId" required disabled>
        <option value="">カレンダーを選択してください</option>
      </select>
      <div id="event-loader" class="loader"></div>
    </div>
  </div>

  <div id="editor-container" class="hidden">
    <hr>
    <div class="button-group">
        <button id="mode-toggle-button" class="secondary">JSONモードに切り替え</button>
    </div>

    <div id="conference-form-container">
        <h3>会議ソリューション</h3>
        <div>
          <label for="name">名前:</label>
          <input type="text" id="name" name="name">
        </div>
        <div>
          <label for="iconUri">アイコン URI:</label>
          <input type="url" id="iconUri" name="iconUri">
          <p id="icon-uri-warning" class="warning-text hidden">警告: このホスト名の画像は、Googleカレンダーで正しく表示されない可能性があります。</p>
          <img id="icon-preview" src="" alt="Icon Preview">
          <a id="icon-link" href="#" target="_blank" style="display: none; margin-left: 10px;">リンクを確認</a>
        </div>
        <div>
          <label for="type">キータイプ:</label>
          <select id="type" name="type">
            <option value="addOn">addOn</option>
            <option value="hangoutsMeet">hangoutsMeet</option>
            <option value="eventHangout">eventHangout</option>
            <option value="eventNamedHangout">eventNamedHangout</option>
          </select>
        </div>
        <div>
          <label for="conferenceId">会議 ID:</label>
          <input type="text" id="conferenceId" name="conferenceId">
        </div>
        <div>
          <label for="notes">メモ:</label>
          <textarea id="notes" name="notes" rows="4"></textarea>
        </div>

        <h3>エントリーポイント</h3>
        <div id="entry-points-container"></div>
        <button type="button" id="add-entry-point">エントリーポイントを追加</button>
    </div>

    <div id="json-editor-container" class="hidden">
        <h3>JSONエディタ</h3>
        <textarea id="json-editor"></textarea>
    </div>

    <div class="button-group">
      <button id="submit-button">会議情報を更新</button>
      <button id="delete-button" style="background-color: #db4437;">会議情報を削除</button>
    </div>
  </div>

  <div id="status"></div>

  <template id="entry-point-template">
    <div class="entry-point">
      <div>
        <label>タイプ:</label>
        <select class="entryPointType">
          <option value="video">video</option>
          <option value="phone">phone</option>
          <option value="sip">sip</option>
          <option value="more">more</option>
        </select>
      </div>
      <div>
        <label>ラベル:</label>
        <input type="text" class="label">
      </div>
      <div>
        <label>URI:</label>
        <input type="url" class="uri">
      </div>
      <button type="button" class="remove-entry-point">このエントリーポイントを削除</button>
    </div>
  </template>

  <script>
    // --- Element References ---
    const calendarSelect = document.getElementById('calendar-select');
    const eventSelect = document.getElementById('event-select');
    const eventLoader = document.getElementById('event-loader');
    const editorContainer = document.getElementById('editor-container');
    const conferenceFormContainer = document.getElementById('conference-form-container');
    const jsonEditorContainer = document.getElementById('json-editor-container');
    const jsonEditor = document.getElementById('json-editor');
    const modeToggleButton = document.getElementById('mode-toggle-button');
    const statusDiv = document.getElementById('status');
    const entryPointsContainer = document.getElementById('entry-points-container');
    const entryPointTemplate = document.getElementById('entry-point-template');

    let currentMode = 'FORM'; // 'FORM' or 'JSON'
    // For details on the hostname restriction, see: https://developers.google.com/workspace/add-ons/calendar/conferencing/providing-logos
    const ALLOWED_ICON_HOSTNAMES = [
        'fonts.gstatic.com',
        'lh3.googleusercontent.com',
        'lh4.googleusercontent.com',
        'lh5.googleusercontent.com',
        'lh6.googleusercontent.com'
    ];

    // --- Utility Functions ---
    function populateSelect(select, items, defaultOptionText) {
      select.innerHTML = '';
      const defaultOption = new Option(defaultOptionText, '', true, true);
      defaultOption.disabled = true;
      select.add(defaultOption);
      items.forEach(item => select.add(new Option(item.summary, item.id)));
      select.disabled = false;
    }

    function setStatus(message, isError = false, isLoading = false) {
      statusDiv.style.display = 'block';
      statusDiv.textContent = message;
      statusDiv.className = isError ? 'error' : (isLoading ? '' : 'success');
    }

    function isValidUrl(string) {
      if (!string) return true; // Allow empty URLs
      try {
        new URL(string);
        return true;
      } catch (_) {
        return false;
      }
    }

    function validateIconHost(iconUrl) {
        if (!iconUrl || !isValidUrl(iconUrl)) {
            return true; // Don't validate if it's empty or not a URL
        }
        try {
            const hostname = new URL(iconUrl).hostname;
            return ALLOWED_ICON_HOSTNAMES.includes(hostname);
        } catch (e) {
            return false;
        }
    }

    function runGoogleScript(funcName, ...args) {
      return new Promise((resolve, reject) => {
        google.script.run
          .withSuccessHandler(resolve)
          .withFailureHandler(reject)
          [funcName](...args);
      });
    }

    // --- Data Building and Population ---
    function buildConferenceDataFromForm() {
        const entryPointElements = entryPointsContainer.querySelectorAll('.entry-point');
        const entryPoints = [];
        entryPointElements.forEach(ep => {
            entryPoints.push({
            entryPointType: ep.querySelector('.entryPointType').value,
            label: ep.querySelector('.label').value,
            uri: ep.querySelector('.uri').value,
            });
        });

        return {
            conferenceId: document.getElementById('conferenceId').value,
            conferenceSolution: {
            key: { type: document.getElementById('type').value },
            name: document.getElementById('name').value,
            iconUri: document.getElementById('iconUri').value,
            },
            notes: document.getElementById('notes').value,
            entryPoints: entryPoints
        };
    }

    function addEntryPoint(data = {}) {
      const clone = entryPointTemplate.content.cloneNode(true);
      const entryPointDiv = clone.querySelector('.entry-point');

      entryPointDiv.querySelector('.entryPointType').value = data.entryPointType || 'video';
      entryPointDiv.querySelector('.label').value = data.label || '';
      entryPointDiv.querySelector('.uri').value = data.uri || '';

      entryPointDiv.querySelector('.remove-entry-point').addEventListener('click', () => {
        entryPointsContainer.removeChild(entryPointDiv);
      });
      entryPointsContainer.appendChild(clone);
    }

    function populateForm(data = {}) {
      const d = data || {};
      const sol = d.conferenceSolution || {};
      const key = sol.key || {};

      document.getElementById('name').value = sol.name || '';
      document.getElementById('iconUri').value = sol.iconUri || '';
      document.getElementById('type').value = key.type || 'addOn';
      document.getElementById('conferenceId').value = d.conferenceId || '';
      document.getElementById('notes').value = d.notes || '';

      updateIconPreview();

      entryPointsContainer.innerHTML = '';
      if (d.entryPoints && d.entryPoints.length > 0) {
        d.entryPoints.forEach(ep => addEntryPoint(ep));
      } else {
        addEntryPoint(); // Add one blank entry point if none exist
      }
      editorContainer.classList.remove('hidden');
    }

    function updateIconPreview() {
        const iconUriInput = document.getElementById('iconUri');
        const iconPreview = document.getElementById('icon-preview');
        const iconLink = document.getElementById('icon-link');
        const warning = document.getElementById('icon-uri-warning');

        const url = iconUriInput.value;
        if (isValidUrl(url)) {
            iconPreview.src = url;
            iconPreview.style.display = 'inline-block';
            iconLink.href = url;
            iconLink.style.display = 'inline-block';
        } else {
            iconPreview.style.display = 'none';
            iconLink.style.display = 'none';
        }

        if (url && !validateIconHost(url)) {
            warning.classList.remove('hidden');
        } else {
            warning.classList.add('hidden');
        }
    }

    // --- Mode Toggling ---
    function toggleMode() {
        if (currentMode === 'FORM') {
            // Switch to JSON mode
            try {
                const data = buildConferenceDataFromForm();
                jsonEditor.value = JSON.stringify(data, null, 2);
                currentMode = 'JSON';
                conferenceFormContainer.classList.add('hidden');
                jsonEditorContainer.classList.remove('hidden');
                modeToggleButton.textContent = 'フォームモードに切り替え';
            } catch (err) {
                setStatus('フォームからJSONへの変換に失敗しました: ' + err.message, true);
            }
        } else {
            // Switch to FORM mode
            try {
                const data = JSON.parse(jsonEditor.value);
                populateForm(data); // This repopulates the form with the JSON content
                currentMode = 'FORM';
                jsonEditorContainer.classList.add('hidden');
                conferenceFormContainer.classList.remove('hidden');
                modeToggleButton.textContent = 'JSONモードに切り替え';
            } catch (err) {
                setStatus('JSONのパースに失敗しました。フォーマットを確認してください。: ' + err.message, true);
            }
        }
    }

    // --- Event Listeners ---
    window.addEventListener('load', async () => {
      try {
        const calendars = await runGoogleScript('getCalendars');
        if (calendars && calendars.length > 0) {
          populateSelect(calendarSelect, calendars, 'カレンダーを選択');
        } else {
          calendarSelect.innerHTML = '<option value="">利用可能なカレンダーがありません</option>';
        }
      } catch (err) {
        setStatus('カレンダーの読み込みに失敗: ' + err.message, true);
      }
    });

    calendarSelect.addEventListener('change', async () => {
      const calendarId = calendarSelect.value;
      if (!calendarId) return;

      eventSelect.disabled = true;
      editorContainer.classList.add('hidden');
      eventSelect.innerHTML = '<option value="">イベントを読み込み中...</option>';
      eventLoader.style.display = 'inline-block';

      try {
        const events = await runGoogleScript('getEvents', calendarId);
        if (events && events.length > 0) {
          populateSelect(eventSelect, events, 'イベントを選択');
        } else {
          eventSelect.innerHTML = '<option value="">イベントが見つかりません</option>';
        }
      } catch (err) {
        setStatus('イベントの読み込みに失敗: ' + err.message, true);
      } finally {
        eventLoader.style.display = 'none';
      }
    });

    eventSelect.addEventListener('change', async () => {
      const eventId = eventSelect.value;
      const calendarId = calendarSelect.value;
      if (!eventId || !calendarId) {
        editorContainer.classList.add('hidden');
        return;
      }

      setStatus('会議情報を読み込み中...', false, true);
      try {
        const confData = await runGoogleScript('getConferenceData', calendarId, eventId);
        populateForm(confData);
        statusDiv.style.display = 'none';
      } catch (err) {
        setStatus('会議情報の読み込みに失敗しました: ' + err.message, true);
        editorContainer.classList.add('hidden');
      }
    });

    document.getElementById('iconUri').addEventListener('input', updateIconPreview);
    document.getElementById('add-entry-point').addEventListener('click', () => addEntryPoint());
    modeToggleButton.addEventListener('click', toggleMode);

    document.getElementById('submit-button').addEventListener('click', async (e) => {
      e.preventDefault();

      const calendarId = calendarSelect.value;
      const eventId = eventSelect.value;
      let conferenceData;

      if (currentMode === 'JSON') {
          try {
              conferenceData = JSON.parse(jsonEditor.value);
          } catch (err) {
              setStatus('JSONのフォーマットが不正です。修正してください。: ' + err.message, true);
              return;
          }
      } else {
          conferenceData = buildConferenceDataFromForm();
      }

      // --- Validation ---
      const iconUri = conferenceData?.conferenceSolution?.iconUri;
      if (!validateIconHost(iconUri)) {
          setStatus('アイコンURIのホスト名が許可されていません。警告を確認してください。', true);
          return;
      }

      let allUrlsValid = true;
      if (iconUri && !isValidUrl(iconUri)) {
          allUrlsValid = false;
      }
      conferenceData?.entryPoints?.forEach(ep => {
        if (ep.uri && !isValidUrl(ep.uri)) allUrlsValid = false;
      });
      if (!allUrlsValid) {
          setStatus('無効なURLが含まれています。修正してください。', true);
          return;
      }

      setStatus('会議情報を更新中...', false, true);
      try {
        const response = await runGoogleScript('updateConferenceData', calendarId, eventId, conferenceData);
        setStatus(response.message, !response.success);
      } catch (err) {
        setStatus('更新に失敗しました: ' + err.message, true);
      }
    });

    document.getElementById('delete-button').addEventListener('click', async () => {
        if (!confirm('本当にこのイベントの会議情報をすべて削除しますか？')) return;

        const calendarId = calendarSelect.value;
        const eventId = eventSelect.value;
        setStatus('会議情報を削除中...', false, true);
        try {
            const response = await runGoogleScript('updateConferenceData', calendarId, eventId, null);
            setStatus(response.message, !response.success);
            if(response.success) {
                populateForm(null);
            }
        } catch (err) {
            setStatus('削除に失敗しました: ' + err.message, true);
        }
    });

  </script>
</body>
</html>
